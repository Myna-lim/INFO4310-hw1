<html>
    <h3>Myna Lim (ml2326) HW 1</h3>
    <head>
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://d3js.org/topojson.v3.min.js"></script>
    </head>
    <style>
        * {
            font-family: Verdana;
        }

    .gridlines line {
        stroke: #bbb;
      }
      
    .gridlines .domain {
    stroke: none;
    }

    .state {
      fill: lightgrey;
    }

    .neighbor_outline {
      fill: none;
      stroke: white;
      stroke-width: 0.6px;
    }


    .gridlines line {
        stroke: #bbb;
      }
      
    .gridlines .domain {
    stroke: none;
    }
    </style>

    <body>


        <p id="1_vis">
             </br>
            <svg id="choropleth" height="620" width="800"  style="margin:0px" ></svg>
            <svg id="barchart" height="400" width="610" style="border:1px solid gray; background: white; "></svg>
            <ul id="scales"></ul>
          <script>
            const svg = d3.select("#choropleth");
            const width = svg.attr("width");
            const height = svg.attr("height");
            const margin = { top: 90, right: 20, bottom: 20, left:0};
            const mapWidth = width - margin.left - margin.right;
            const mapHeight = height - margin.top - margin.bottom;
            const map = svg.append("g")
                  .attr("transform","translate("+margin.left+","+margin.top+")");

            let annotations = svg.append("g").attr("id","annotations");


            const requestData = async function() {
                const tree = await d3.json('SF-Neighborhoods.geo.json');
                const points = await d3.csv('Stree_Tree_List_new.csv');
                console.log(tree);
                console.log(tree);


                var neighbor = topojson.feature(tree, tree.objects.SFNeighborhoods); 
                var neighborMesh = topojson.mesh(tree, tree.objects.SFNeighborhoods);
                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], neighbor);
                var path = d3.geoPath().projection(projection);


                const colorScale = d3.scaleOrdinal( ["#355E3B","#189900","#D4FECC"] );



                map.selectAll("path.state").data(neighbor.features)
                     .join("path")
                     .attr("d", path)
                     .style("fill", "#d1d1d1");


                map.append("path").datum(neighborMesh)
                    .attr("class","neighbor_outline")
                    .attr("d", path); 

                

                points.forEach( (d, i) => {
                        d.position = projection( [d.Longitude, d.Latitude] );
                        });
                

                map.selectAll("circle")
                    .data(points)
                    .join("circle")
                    .attr("cx", d => d.position[0])
                    .attr("cy", d => d.position[1])
                    .attr("r", d => d.SiteOrder/2)
                    .attr("opacity", 0.2)
                    .style("fill",  d => colorScale( d.qCaretaker ));
                //legend
                svg.append("circle").attr("cx",140).attr("cy",70).attr("r", 6).style("fill", "#355E3B");
                svg.append("circle").attr("cx",140).attr("cy",100).attr("r", 6).style("fill", "#189900");
                svg.append("circle").attr("cx",140).attr("cy",130).attr("r", 6).style("fill", "#D4FECC");
                svg.append("text").attr("x", 160).attr("y", 70).text("Private").style("font-size", "15px").attr("alignment-baseline","middle");
                svg.append("text").attr("x", 160).attr("y", 100).text("DPW").style("font-size", "15px").attr("alignment-baseline","middle");
                svg.append("text").attr("x", 160).attr("y", 130).text("Others").style("font-size", "15px").attr("alignment-baseline","middle");
                svg.append("text").attr("x", 140).attr("y", 40).text("* Size of the points: the # of site orders (Order of tree at address \n where multiple trees are at same address)").style("font-size", "12px").attr("alignment-baseline","middle");
                svg.append("text").attr("x", 300).attr("y", 20).text("Who are the Caretakers of SF Trees?").style("font-size", "20px").attr("alignment-baseline","middle");

            // Bar chart

            const top5 = await d3.csv('caretaker_counts.csv');

            const svgChart = d3.select("#barchart");
            const maptitle = d3.select("#maptitle");
            const charttitle = d3.select("#charttitle");
            const width2 = svgChart.attr("width");
            const height2 = svgChart.attr("height");
            const chartMargin = { top: 20, right: 20, bottom: 75, left: 30 };
            const chartWidth = width2 - chartMargin.left - chartMargin.right;
            const chartHeight = height2 - chartMargin.top - chartMargin.bottom;
            const barchart = svgChart.append("g")
                                    .attr("transform", "translate(" + chartMargin.left + "," + chartMargin.top + ")");

            //const top_5 = ["Platanus x hispanica :: Sycamore: London Plane", "Metrosideros excelsa :: New Zealand Xmas Tree", "Lophostemon confertus :: Brisbane Box", "Pittosporum undulatum :: Victorian Box", "Tristaniopsis laurina :: Swamp Myrtle"];
            top5.count = parseInt(top5.count);
            const subgroups = d3.map(top5, d => d.qCaretaker);
            
            const species = d3.map(top5, d => d.qSpecies);
            const species_short = d3.map(top5, d => d.qSpecies.split('::')[1].trim());
            const speciesScale = d3.scaleBand().domain(species).range([0, chartWidth-20]) //x axis
                                       .padding(0.2);
            const speciesScale_short = d3.scaleBand().domain(species_short).range([0, chartWidth-20]) //x axis
                                       .padding(0.2);

            const colorScale2 = d3.scaleOrdinal()
                                  .domain(subgroups)
                                  .range(['#189900', '#355E3B', '#D4FECC']) //colors

            const maxcount = d3.max( top5, d => parseInt(d.count) );
            const countScale = d3.scaleLinear().domain([0, maxcount+200]).range([chartHeight, 0]); //yaxis
            
            //Axes and gridlines
            let leftAxis = d3.axisLeft(countScale)
                                .tickFormat(d3.format(""));  
            let leftGridlines = d3.axisLeft(countScale)
                                    .tickSize(-chartWidth-10)
                                    .tickFormat("")
            let bottomAxis = d3.axisBottom(speciesScale_short); 
            let bottomGridlines = d3.axisBottom(speciesScale)
                                    .tickSize(-chartHeight-10)
                                    .tickFormat("");

            barchart.append("g")
                .attr("class", "y axis")
                .attr("transform","translate("+(chartMargin.left-5)+","+chartMargin.top+")")
                .call(leftAxis);
            barchart.append("g")
                .attr("class", "y gridlines")
                .attr("transform","translate("+(chartMargin.left-5)+","+chartMargin.top+")")
                .call(leftGridlines);
            barchart.append("g")
                .attr("class", "x axis")
                .attr("transform","translate("+chartMargin.left+","+(chartHeight+chartMargin.top+10)+")")
                .call(bottomAxis)
                .selectAll("text")
                .attr("font-size", "9.5px");
            barchart.append("g")
                .attr("class", "x gridlines")
                .style("stroke", '#0000FF')
                .attr("transform","translate("+chartMargin.left+","+(chartHeight+chartMargin.top+10)+")")
                .call(bottomGridlines);

            // adding histogram bars
            
            //for Private
            barchart.selectAll('rect.bar').data( top5.filter(function(d){ return d.qCaretaker == "Private" }))
                .join('rect')
                .attr('class','privatebar')
                .attr("x", d => speciesScale(d.qSpecies)+22)
                .attr("y", d => countScale(d.count))
                .attr("height", d => countScale(0) - countScale(d.count)+20)
                .attr("width", speciesScale.bandwidth()/2.5)
                .style("fill", d => colorScale2(d.qCaretaker));
            
            //for DPW
            barchart.selectAll('rect.bar').data( top5.filter(function(d){ return d.qCaretaker == "DPW" }))
                .join('rect')
                .attr('class','dpwbar')
                .attr("x", d => speciesScale(d.qSpecies)+55)
                .attr("y", d => countScale(d.count))
                .attr("height", d => countScale(0) - countScale(d.count)+20)
                .attr("width", speciesScale.bandwidth()/2.5)
                .style("fill",d => colorScale2(d.qCaretaker));

            //for others
            barchart.selectAll('rect.bar').data( top5.filter(function(d){ return d.qCaretaker == "others" }))
                .join('rect')
                .attr('class','otherbar')
                .attr("x", d => speciesScale(d.qSpecies)+88)
                .attr("y", d => countScale(d.count))
                .attr("height", d => countScale(0) - countScale(d.count)+20)
                .attr("width", speciesScale.bandwidth()/2.5)
                .style("fill", d => colorScale2(d.qCaretaker));
              
            //x label
            barchart.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "end")
                .style("font-size", "13px")
                .attr("x", chartWidth - 210)
                .attr("y", chartHeight + 65)
                .text("Top 5 Trees in SF");

            //y label
            barchart.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "end")
                .attr("x", -120)
                .attr("y", -14)
                .style("font-size", "13px")
                .attr("transform", "rotate(-90)")
                .text("Number of Trees");

            // barchart title
            barchart.append("text")
                    .attr("class", "bartitle")
                    .attr("text-anchor", "middle")
                    .attr("x", chartWidth - 270)
                    .attr("y", 8)
                    .style("font-size", "15px")
                    .text("Who are the Caretakers for the Top 5 Tree Species in SF?");


            //legend
            barchart.append("rect").attr("x",490).attr("y",25).attr("width", 90).attr("height", 65).style("fill", "white").style("stroke", "black");
            barchart.append("circle").attr("cx",500).attr("cy",40).attr("r", 5).style("fill", "#355E3B");
            barchart.append("circle").attr("cx",500).attr("cy",60).attr("r", 5).style("fill", "#189900");
            barchart.append("circle").attr("cx",500).attr("cy",80).attr("r", 5).style("fill", "#D4FECC");
            barchart.append("text").attr("x", 520).attr("y", 40).text("Private").style("font-size", "11px").attr("alignment-baseline","middle");
            barchart.append("text").attr("x", 520).attr("y", 60).text("DPW").style("font-size", "11px").attr("alignment-baseline","middle");
            barchart.append("text").attr("x", 520).attr("y", 80).text("Others").style("font-size", "11px").attr("alignment-baseline","middle");

            } 
            requestData();
          </script>
      </p>
    </body>
</html>